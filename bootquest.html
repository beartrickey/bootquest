

<html>

	<head>

		<title>
			AwesomeStrapCloudQuest
		</title>

		<!-- fonts -->
		<link href='http://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>


		<!-- jquery -->
		<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>

		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

		<!-- Optional theme -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">

		<!-- Latest compiled and minified JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

		<!-- font awesome -->
		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

		<style>

			body
			{
				background-color: LightBlue;
			}


			.title
			{
				position: absolute;
				font-size: 75px;
				font-family: Montserrat;
				color: white
			}

			#player{
				color: white;
				position: absolute;
				top: 160px;
				left: 674px;
			}

			#toolTip{
				position:absolute;
				left: 50px;
				top: 80%;
				font-size: 20px;
				z-index: 100;
			}

		</style>

		<script type="text/javascript">

			var gameStarted = false;

			// Player vars
			var player = null;
			var playerVelocity = new Point(0.0, 0.0);
			var playerPosition = new Point(0.0, 0.0);
			var playerHeight = 35.0;
			var playerWidth = 20.0;
			var playerDistanceFromGround = 0.0;
			var currentBar = null;
			var friction = 0.875;
			var gravity = 0.5;
			
			// Window dimensions
			var groundLevel = 650.0;
			var rightLimit = 0;
			
			// Terrain progress bars
			var numBars = 256;
			var numActiveBars = 0;
			var barThickness = 20;
			var progressBars = [];
			
			// Clouds
			var numClouds = 4;
			var clouds = [];

			// Wifis
			var wifiReloadSpeed = 10;
			var wifiReloadCounter = 0;
			var wifiSpeed = 3.0;
			var numWifis = 16;
			var wifis = [];

			// Files
			var numFiles = 16;
			var files = [];


			function gameNode()
			{

			};


			$(document).ready( function(){

				// ====================================================
				// Window Management
				// ====================================================

				// Disable scrolling
				$("body").css("overflow", "hidden");

				// Handle window resizing
				onResize();

				$(window).resize(function(){
					onResize();
				});

				// ====================================================
				// Game objects
				// ====================================================

				// Clouds
				placeClouds();

				// Progress bars
				makeProgressBars();

				// Wifis
				makeWifis();

				// player
				player = $('#player');
				playerPosition = new Point(parseFloat(player.css('left')), parseFloat(player.css('top')));

				// start game on player click
				player.click( function(){
					if( gameStarted == false )
					{
						gameStarted = true;
						
					}
				});

				// ====================================================
				// Start the game loop
				// ====================================================
				update();

			});


			function onResize()
			{
				rightLimit = $( window ).width();
				groundLevel = $( window ).height();
			}


			function makeProgressBars()
			{

				var runningHeight = 700.0;
				var maxHeight = 300.0;

				for( var i = 0; i < numBars; i++ )
				{

					// var top = runningHeight + Math.floor((Math.random() * 20)) - 10;
					var top = runningHeight + Math.floor((Math.random() * 40)) - 20;

					// Clamping
					if( top > groundLevel - 20 )
						top = groundLevel - 20;
					if( top < maxHeight )
						top = maxHeight;

					// Incremeents of 5
					top = Math.ceil(top/5) * 5.0;

					var distanceToGround = groundLevel - top;
					var thisBarLength = distanceToGround * 2.0;
					var left = (i * barThickness) - (thisBarLength * 0.5) - (barThickness * 0.5);
					runningHeight = top;

					// console.log( mousex + ', ' + left);

					var rootDiv = $('<div/>', {
					    id: 'bar_' + i,
					    class: 'progress',
					    style: 'position:absolute;width:' + thisBarLength + 'px;top:' + top + 'px;left:' + left + 'px;',
					}).appendTo( $("body") );

					var barDiv = $('<div/>', {
					    class: 'progress-bar progress-bar-striped progress-bar-success',
					    role: 'progressbar',
					    style: 'width:100%',
					}).appendTo(rootDiv);

					// Rotate
					rotate( rootDiv, 270 );

					var progressNode = new gameNode();
					progressNode.left = left;
					progressNode.top = top;
					progressNode.width = thisBarLength;
					progressBars.push( progressNode );

				}

			};


			function makeWifis()
			{

				for( var i = 0; i < numWifis; i++ )
				{

					var wifiDiv = $('<i/>', {
					    id: 'wifi_' + i,
					    class: 'wifi fa fa-wifi',
					    style: 'position:absolute;top:0px;left:0px;color:white;font-size:2em;visibility:hidden',
					}).appendTo( $("body") );

					var wifiNode = new gameNode();
					wifiNode.wifiDiv = wifiDiv.get(0);
					wifiNode.active = false;
					wifiNode.left = 0.0;
					wifiNode.top = 0.0;
					wifiNode.velocity = new Point(0.0, 0.0);
					wifis.push( wifiNode );

				}

			};


			function getFreeWifi()
			{

				for( var i = 0; i < numWifis; i++ )
				{

					if( wifis[i].active == false )
					{
						return wifis[i];
					}

				}

				return null;

			};

			
			function placeClouds()
			{

				for( var i = 0; i < numClouds; i++ )
				{

					var top = Math.floor((Math.random() * (groundLevel - 500.0))) + 200.0;
					var left = Math.floor(Math.random() * (rightLimit - 64.0));

					var cloudDiv = $('<i/>', {
					    id: 'cloud_' + i,
					    class: 'cloud fa fa-cloud',
					    style: 'position:absolute;top:' + top + 'px;left:' + left + 'px;color:white;font-size:7em;',
					}).appendTo( $("body") );

					var cloudNode = new gameNode();
					cloudNode.cloudDiv = cloudDiv.get(0);
					cloudNode.top = top;
					cloudNode.left = left;
					cloudNode.jitterCounter = 0;
					cloudNode.scale = 1.0;
					clouds.push( cloudNode );

				}

			};


			function update()
			{

				setTimeout( 'update()', 16 );

				if( gameStarted == false )
					return;
				

				// Input
				// Space
				if(keyStates["32"] == true)
					playerJump();

				// A 65
				if( keyStates["65"] == true )
					playerMoveHorizontal(-1.0);

				// D 68
				if( keyStates["68"] == true )
					playerMoveHorizontal(1.0);

				// Left 37
				if( keyStates["37"] == true )
					shootWifi(-1.0);

				// Right 38
				if( keyStates["38"] == true )
					shootWifi(0.0);

				// Right 39
				if( keyStates["39"] == true )
					shootWifi(1.0);


				// Update player physics
				// Apply friction
				playerPositionLastFrame = new Point( playerPosition.x, playerPosition.y );

				playerVelocity.x *= friction;
				playerVelocity.y += gravity;

				playerPosition.x += playerVelocity.x;
				playerPosition.y += playerVelocity.y;


				// Is the player still on current bar?
				if( currentBar != null )
				{
					var distanceX = playerPosition.x - currentBar.left - (currentBar.width * 0.5) + 10.0;

					if( Math.abs(distanceX) <= (barThickness * 0.5) )
					{
						// Player is still over current bar. Do nothing
					}
					else
					{
						currentBar = null;
					}

				}


				// Check for new bar if null
				if( currentBar == null )
				{
					checkForBarCollision();
				}
				

				// If the player is over a bar, check if player fell through ground
				if( currentBar != null )
				{
					var barTop = currentBar.top - (currentBar.width * 0.5) - (playerHeight * 0.5);
					playerDistanceFromGround = playerPosition.y - barTop;

					if( playerPosition.y > barTop )// Snap player to top of bar
					{
						playerPosition.y = barTop;
						playerVelocity.y *= -0.5;
					}
				}
				else
				{
					// console.log('player has no bar. falling');
				}


				// Clamp at bottom of screen
				if( playerPosition.y >= groundLevel )
				{
					playerPosition.y = groundLevel;
					playerVelocity.y *= -0.5;
				}

				if( playerPosition.x < 0.0 )
				{
					playerPosition.x = 0.0;
				}
				else if( playerPosition.x > rightLimit - playerWidth )
				{
					playerPosition.x = rightLimit - playerWidth;
				}


				// Update position
				player.css('left', playerPosition.x);
				player.css('top', playerPosition.y);


				// Update toolTip
				


				// update clouds
				for(var c = 0; c < numClouds; c++)
				{
				    cloud = clouds[c];
				    cloud.left -= 0.5;

				    var randOffsetX = 0.0;
				    var randOffsetY = 0.0;
				    if( cloud.jitterCounter > 0 )
				    {
				    	cloud.jitterCounter--;
				    	randOffsetX = (Math.random() * 10.0) - 5.0;
				    	randOffsetY = (Math.random() * 10.0) - 5.0;

				    	// Clouds shrink as they jitter
				    	cloud.scale -= 0.01;
				    	cloud.cloudDiv.style.transform = "scale(" + cloud.scale + "," + cloud.scale + ")";

				    	// Reset cloud when small enough
				    	if( cloud.scale <= 0.1 )
				    	{
				    		cloud.scale = 1.0;
				    		cloud.left = rightLimit - 64.0;
				    	}

				    }

				    
				    // Wrap clouds
				    if( cloud.left < -64.0 )
				    	cloud.left = rightLimit - 64.0;

				    cloud.cloudDiv.style.left = cloud.left + randOffsetX;
				    cloud.cloudDiv.style.top = cloud.top + randOffsetY;
				}


				// Update wifis
				wifiReloadCounter--;
				for( var w = 0; w < numWifis; w++ )
				{
					if( wifis[w].active == true )
					{
						var wifi = wifis[w];
						wifi.left += wifi.velocity.x;
						wifi.top += wifi.velocity.y;
						wifi.wifiDiv.style.left = wifi.left;
						wifi.wifiDiv.style.top = wifi.top;

						// Deactivate if outside screen
						if(
							wifi.left > rightLimit - 64.0 ||
							wifi.left < -64.0 ||
							wifi.top < 0.0 
						)
						{
							wifi.active = false;
							wifi.wifiDiv.style.visibility = 'hidden';
						}

						// Cloud collision
						for( var c = 0; c < numClouds; c++ )
						{
							var cloud = clouds[c];
							var halfCloudSize = 50.0;
							var halfWifiSize = 10.0;
							var distance = Math.sqrt(
								Math.pow(((wifi.top + halfWifiSize) - (cloud.top + halfCloudSize)), 2) +
								Math.pow(((wifi.left + halfWifiSize) - (cloud.left + halfCloudSize)), 2)
							);
							var threshold = 50.0;

							if( distance < threshold )
							{
								wifi.active = false;
								wifi.wifiDiv.style.visibility = 'hidden';
								cloud.jitterCounter = 10;
								break;
							}

						}

					}
				}

			};


			function checkForBarCollision()
			{

				// Player could be over a gap, or a new bar. Check.
				for(var p = 0; p < numBars; p++)
				{

					// Is player in the same x space?
					var progressBar = progressBars[p];
					var distanceX = playerPosition.x - progressBar.left - (progressBar.width * 0.5) + 10.0;

					if( Math.abs(distanceX) <= (barThickness * 0.5) )
					{

						// The player is over this bar, but are they high enough to climb on top?
						var barTop = progressBar.top - (progressBar.width * 0.5) - (playerHeight * 0.5);

						// Can player reach the top?
						playerDistanceFromGround = playerPosition.y - barTop;

						// Prevent player from landing on/climbing up to new ground if distance is too high
						var climbingThreshold = barTop + (playerHeight * 0.5);
						if( playerPosition.y > climbingThreshold )
						{
							// console.log( playerPositionLastFrame.x, playerPosition.x );
							playerPosition.x = playerPositionLastFrame.x;
							playerVelocity.x = 0.0;

							//Search for last bar then return
							checkForBarCollision();
							return false;

						}
						else// Player is safely over new bar
						{
							currentBar = progressBar;
							return false;
						}
						
					}

				}
				
			};

			function shootWifi( direction )
			{

				if( wifiReloadCounter > 0 )
					return;

				var wifi = getFreeWifi();

				if( wifi == null )
					return;

				wifiReloadCounter = wifiReloadSpeed;
				
				wifi.active = true;
				wifi.wifiDiv.style.visibility = 'visible';
				wifi.velocity = new Point( direction * wifiSpeed, -wifiSpeed );
				wifi.left = playerPosition.x - 5.0;
				wifi.top = playerPosition.y;

				// Rotate
				if( direction == 1.0 )
					rotate( $("#" + wifi.wifiDiv.id), 45 );
				else if( direction == -1.0 )
					rotate( $("#" + wifi.wifiDiv.id), 315 );
				else if( direction == 0.0 )
					rotate( $("#" + wifi.wifiDiv.id), 0 );
			};

			function rotate( _element, _angle )
			{

			    var rotate = 'rotate(' + _angle + 'deg)';

			    _element.css({
			        '-webkit-transform': rotate,
			        '-moz-transform': rotate,
			        '-o-transform': rotate,
			        '-ms-transform': rotate,
			        'transform': rotate
			    })

			};


			function Point(_x, _y)
			{
				this.x = _x;
				this.y = _y;
			};



			function Point3( _x, _y, _z)
			{
				this.x = _x;
				this.y = _y;
				this.z = _z;
			};


			function playerJump()
			{
				// Only jump from the ground
				if( playerDistanceFromGround == null )
					return;

				// Don't allow jump if already moving upward
				if( playerVelocity.y < -5.0 )
					return;

				if( Math.abs(playerDistanceFromGround) <= 5.0 )
					playerVelocity.y = -10.0;
			};


			function playerMoveHorizontal( direction )
			{
				playerVelocity.x += direction * 0.5;
			};



			var keyStates = {};
			function keyDown(e)
			{

				// console.log(e.keyCode);

				//prevent defaults
				if( e.keyCode == '37' || e.keyCode == '39' || e.keyCode == '38' || e.keyCode == '40' )
					e.preventDefault();
				
				keyStates[e.keyCode] = true;
			};

			function keyUp(e)
			{
				// console.log(e.keyCode);
				keyStates[e.keyCode] = false;
			}

		</script>

	</head>

	<body onkeydown='keyDown(event)' onkeyup='keyUp(event)'>

		<p class='title'>AwesomeStrap CloudQuest</p>

		<i id='player' class='fa fa-female fa-2x'></i>

		<div id='toolTip' class='label label-info'>

			A : Left
			<br><br>
			B : Right
			<br><br>
			SPACE : Jump
			
		</div>

	</body>

</html>

