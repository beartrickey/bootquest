

<html>

	<head>

		<title>
			bootquest
		</title>

		<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>

		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

		<!-- Optional theme -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">

		<!-- Latest compiled and minified JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

		<!-- font awesome -->
		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

		<style>

			body
			{
				background-color: LightBlue;
				cursor: crosshair;
				/*background: -webkit-linear-gradient(DarkBlue, LightBlue); /* For Safari 5.1 to 6.0 */*/
				/*background: -o-linear-gradient(DarkBlue, LightBlue);  For Opera 11.1 to 12.0 */
				/*background: -moz-linear-gradient(DarkBlue, LightBlue); /* For Firefox 3.6 to 15 */*/
				/*background: linear-gradient(DarkBlue, LightBlue); /* Standard syntax */*/
			}

			.progress
			{
				-ms-transform: rotate(270deg);
			    -webkit-transform: rotate(270deg);
			    transform: rotate(270deg);
			}

			#player{
				color:black;
				position:absolute;
				top:0;
				left:0;
			}

		</style>

		<script type="text/javascript">

			var player = null;
			var playerVelocity = new Point(0.0, 0.0);
			var playerPosition = new Point(0.0, 0.0);
			var playerHeight = 35.0;
			var playerDistanceFromGround = 0.0;
			var currentBarId = null;
			var friction = 0.875;
			var gravity = 0.5;
			var groundLevel = 800.0;
			var barThickness = 20;
			// var barLength = 50.0;



			$(document).ready( function(){

				// Progress bars
				placeProgressBars();


				// player
				player = $('#player');

				update();

			});


			function placeProgressBars()
			{

				var runningHeight = 700.0;
				var maxHeight = 300.0;

				for( var i = 0; i < 128; i++ )
				{

					var top = runningHeight + Math.floor((Math.random() * 30)) - 15;

					// Clamping
					if( top > groundLevel - 10 )
						top = groundLevel - 10;
					if( top < maxHeight )
						top = maxHeight;

					// Incremeents of 5
					top = Math.ceil(top/5) * 5.0;

					var distanceToGround = groundLevel - top;
					var thisBarLength = distanceToGround * 2.0;
					var left = (i * barThickness) - (thisBarLength * 0.5) - (barThickness * 0.5);
					runningHeight = top;

					// console.log( mousex + ', ' + left);

					var rootDiv = $('<div/>', {
					    id: 'foo_' + i,
					    class: 'progress',
					    style: 'position:absolute;width:' + thisBarLength + 'px;top:' + top + 'px;left:' + left + 'px',
					}).appendTo( $("body") );

					var barDiv = $('<div/>', {
					    id: 'bar',
					    class: 'progress-bar progress-bar-striped progress-bar-success',
					    role: 'progressbar',
					    // aria-valuemin: '0',
					    // aria-valuemax: '100',
					    style: 'width:100%',
					}).appendTo(rootDiv);

				}

			};


			function update()
			{

				setTimeout( 'update()', 16 );
				

				// Input
				// Space
				if(keyStates["32"] == true)
					playerJump();

				// Left 37 / A 65
				if(keyStates["37"] == true || keyStates["65"] == true)
					playerMoveHorizontal(-1.0);

				// Right 39 / D 68
				if(keyStates["39"] == true || keyStates["68"] == true)
					playerMoveHorizontal(1.0);


				// Update player physics
				// Apply friction
				playerPositionLastFrame = new Point( playerPosition.x, playerPosition.y );

				playerVelocity.x *= friction;
				playerVelocity.y += gravity;

				playerPosition.x += playerVelocity.x;
				playerPosition.y += playerVelocity.y;


				// Is the player still on current bar?
				if( currentBarId != null )
				{
					var currentBar = $("#" + currentBarId);
					var barLength = parseFloat(currentBar.css('width'));
					var distanceX = playerPosition.x - parseFloat(currentBar.css('left')) - (barLength * 0.5) + 10.0;

					if( Math.abs(distanceX) <= (barThickness * 0.5) )
					{
						// Player is still over current bar. Do nothing
					}
					else
					{
						currentBarId = null;
					}

				}


				// Check for new bar if null
				if( currentBarId == null )
				{
					checkForBarCollision();
				}
				

				// If the player is over a bar, check if player fell through ground
				if( currentBarId != null )
				{
					var currentBar = $("#" + currentBarId);
					var barTop = parseFloat(currentBar.css('top')) - (barLength * 0.5) - (playerHeight * 0.5);
					playerDistanceFromGround = playerPosition.y - barTop;

					if( playerPosition.y > barTop )// Snap player to top of bar
					{
						playerPosition.y = barTop;
						playerVelocity.y *= -0.5;
					}
				}
				else
				{
					// console.log('player has no bar. falling');
				}


				// Clamp at bottom of screen
				if( playerPosition.y >= groundLevel )
				{
					playerPosition.y = groundLevel;
					playerVelocity.y *= -0.5;
				}

				// Clamp at left limit of screen
				if( playerPosition.x < 0.0 )
				{
					playerPosition.x = 0.0;
				}


				// Update position
				player.css('left', playerPosition.x);
				player.css('top', playerPosition.y);


				// Scroll window?
				// var scrollX = window.screenX;
				// var scrollY = window.screenY;

				window.scrollTo( playerPosition.x - ($(window).width() * 0.5), playerPosition.y );

			};


			function checkForBarCollision()
			{

				// Player could be over a gap, or a new bar. Check.
				$('.progress').each( function() {

					// Is player in the same x space?
					var barLength = parseFloat($(this).css('width'));
					var distanceX = playerPosition.x - parseFloat($(this).css('left')) - (barLength * 0.5) + 10.0;

					if( Math.abs(distanceX) <= (barThickness * 0.5) )
					{

						// The player is over this bar, but are they high enough to climb on top?
						var newBar = $(this);
						var barTop = parseFloat(newBar.css('top')) - (barLength * 0.5) - (playerHeight * 0.5);

						// Can player reach the top?
						// console.log('player collided with new bar');
						playerDistanceFromGround = playerPosition.y - barTop;

						// Prevent player from landing on/climbing up to new ground if distance is too high
						var climbingThreshold = barTop + (playerHeight * 0.5);
						if( playerPosition.y > climbingThreshold )
						{
							// console.log( playerPositionLastFrame.x, playerPosition.x );
							playerPosition.x = playerPositionLastFrame.x;
							playerVelocity.x = 0.0;

							//Search for last bar then return
							// console.log('checking one more time');
							checkForBarCollision();
							return false;

						}
						else// Player is safely over new bar
						{
							currentBarId = newBar.attr('id');
							return false;
						}
						
					}

				});
				
			};


			function Point(_x, _y)
			{
				this.x = _x;
				this.y = _y;
			};



			function Point3( _x, _y, _z)
			{
				this.x = _x;
				this.y = _y;
				this.z = _z;
			};


			function playerJump()
			{
				// Only jump from the ground
				if( playerDistanceFromGround == null )
					return;

				// Don't allow jump if already moving upward
				if( playerVelocity.y < -5.0 )
					return;

				if( Math.abs(playerDistanceFromGround) <= 5.0 )
					playerVelocity.y = -10.0;
			};


			function playerMoveHorizontal( direction )
			{
				playerVelocity.x += direction * 0.5;
			};



			var keyStates = {};
			function keyDown(e)
			{
				// console.log(e.keyCode);
				keyStates[e.keyCode] = true;
			};

			function keyUp(e)
			{
				// console.log(e.keyCode);
				keyStates[e.keyCode] = false;
			}

		</script>

	</head>

	<body onkeydown='keyDown(event)' onkeyup='keyUp(event)'>

		<i id='player' class='fa fa-female fa-2x'></i>

			<!-- 
			<div class="progress" style="position:absolute;width:400px;top:300px;left:120px">
				<div class="progress-bar progress-bar-striped active"  role="progressbar" aria-valuenow="45" aria-valuemin="0" aria-valuemax="100" style="width:100%">
				</div>
			</div>
			-->

	</body>

</html>

