

<html>

	<head>

		<title>
			AwesomeStrapCloudQuest
		</title>

		<!-- fonts -->
		<link href='http://fonts.googleapis.com/css?family=Montserrat' rel='stylesheet' type='text/css'>


		<!-- jquery -->
		<script src="http://code.jquery.com/jquery-1.10.2.min.js"></script>

		<!-- Latest compiled and minified CSS -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css">

		<!-- Optional theme -->
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap-theme.min.css">

		<!-- Latest compiled and minified JavaScript -->
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>

		<!-- font awesome -->
		<link href="https://maxcdn.bootstrapcdn.com/font-awesome/4.2.0/css/font-awesome.min.css" rel="stylesheet">

		<style>

			body
			{
				background-color: LightBlue;
			}


			.title
			{
				/*position: absolute;*/
				font-size: 75px;
				font-family: Montserrat;
				color: white
			}

			.subtitle1
			{
				/*position: absolute;*/
				font-size: 25px;
				font-family: Montserrat;
				color: white
			}

			.subtitle2
			{
				/*position: absolute;*/
				font-size: 15px;
				font-family: Montserrat;
				color: white
			}

			#player{
				color: white;
				position: absolute;
				top: 160px;
				left: 674px;
			}

			#toolTip{
				position:absolute;
				left: 50px;
				top: 80%;
				font-size: 20px;
				z-index: 100;
			}

		</style>

		<script type="text/javascript">

			var gameStarted = false;

			// Player vars
			var player = null;
			var playerVelocity = new Point(0.0, 0.0);
			var playerPosition = new Point(0.0, 0.0);
			var playerHeight = 35.0;
			var playerWidth = 20.0;
			var playerDistanceFromGround = 0.0;
			var currentBar = null;
			var friction = 0.875;
			var gravity = 0.5;
			
			// Window dimensions
			var groundLevel = 650.0;
			var rightLimit = 0;
			
			// Terrain progress bars
			var numBars = 256;
			var numActiveBars = 0;
			var barThickness = 20;
			var progressBars = [];
			
			// Clouds
			var numClouds = 4;
			var clouds = [];

			// Wifis
			var wifiReloadSpeed = 10;
			var wifiReloadCounter = 0;
			var wifiSpeed = 6.0;
			var numWifis = 8;
			var wifis = [];

			// Files
			var numFiles = 16;
			var files = [];


			function gameNode()
			{

			};


			$(document).ready( function(){

				// ====================================================
				// Window Management
				// ====================================================

				// Disable scrolling
				$("body").css("overflow", "hidden");

				// Handle window resizing
				onResize();

				$(window).resize(function(){
					onResize();
				});

				// ====================================================
				// Game objects
				// ====================================================

				// Clouds
				placeClouds();

				// Progress bars
				makeProgressBars();

				// Wifis
				makeWifis();

				// Files
				makeFiles();

				// player
				player = $('#player');
				playerPosition = new Point(parseFloat(player.css('left')), parseFloat(player.css('top')));

				// start game on player click
				player.click( function(){
					if( gameStarted == false )
					{
						gameStarted = true;
					}
				});

				// ====================================================
				// Start the game loop
				// ====================================================
				update();

			});


			function onResize()
			{
				rightLimit = $( window ).width();
				groundLevel = $( window ).height();
			}


			function makeProgressBars()
			{

				var runningHeight = 700.0;
				var maxHeight = 300.0;

				for( var i = 0; i < numBars; i++ )
				{

					// var top = runningHeight + Math.floor((Math.random() * 20)) - 10;
					var top = runningHeight + Math.floor((Math.random() * 40)) - 20;

					// Clamping
					if( top > groundLevel - 20 )
						top = groundLevel - 20;
					if( top < maxHeight )
						top = maxHeight;

					// Incremeents of 5
					top = Math.ceil(top/5) * 5.0;

					var distanceToGround = groundLevel - top;
					var thisBarLength = distanceToGround * 2.0;
					var left = (i * barThickness) - (thisBarLength * 0.5) - (barThickness * 0.5);
					runningHeight = top;

					// console.log( mousex + ', ' + left);

					var rootDiv = $('<div/>', {
					    id: 'bar_' + i,
					    class: 'progress',
					    style: 'position:absolute;width:' + thisBarLength + 'px;top:' + top + 'px;left:' + left + 'px;',
					}).appendTo( $("body") );

					var barDiv = $('<div/>', {
					    class: 'progress-bar progress-bar-striped progress-bar-success',
					    role: 'progressbar',
					    style: 'width:100%',
					}).appendTo(rootDiv);

					// Rotate
					rootDiv.css( "transform", "rotate(270deg)" );

					var progressNode = new gameNode();
					progressNode.left = left;
					progressNode.top = top;
					progressNode.width = thisBarLength;
					progressBars.push( progressNode );

				}

			};


			function makeWifis()
			{

				for( var i = 0; i < numWifis; i++ )
				{

					var wifiDiv = $('<i/>', {
					    id: 'wifi_' + i,
					    class: 'wifi fa fa-wifi',
					    style: 'position:absolute;top:0px;left:0px;color:white;font-size:2em;visibility:hidden',
					}).appendTo( $("body") );

					var wifiNode = new gameNode();
					wifiNode.wifiDiv = wifiDiv.get(0);
					wifiNode.active = false;
					wifiNode.left = 0.0;
					wifiNode.top = 0.0;
					wifiNode.velocity = new Point(0.0, 0.0);
					wifis.push( wifiNode );

				}

			};



			function makeFiles()
			{

				for( var i = 0; i < numFiles; i++ )
				{

					var fileDiv = $('<i/>', {
					    id: 'file_' + i,
					    class: 'file fa fa-file',
					    style: 'position:absolute;top:0px;left:0px;color:white;font-size:2em;visibility:hidden',
					}).appendTo( $("body") );

					var fileNode = new gameNode();
					fileNode.fileDiv = fileDiv.get(0);
					fileNode.active = false;
					fileNode.currentBar = null;
					fileNode.left = 0.0;
					fileNode.top = 0.0;
					fileNode.velocity = new Point(0.0, 0.0);
					files.push( fileNode );

				}

			};


			function getFreeFile()
			{

				for( var i = 0; i < numFiles; i++ )
				{

					if( files[i].active == false )
					{
						return files[i];
					}

				}

				return null;

			};


			function getFreeWifi()
			{

				for( var i = 0; i < numWifis; i++ )
				{

					if( wifis[i].active == false )
					{
						return wifis[i];
					}

				}

				return null;

			};

			
			function placeClouds()
			{

				for( var i = 0; i < numClouds; i++ )
				{

					var cloudDiv = $('<i/>', {
					    id: 'cloud_' + i,
					    class: 'cloud fa fa-cloud',
					    style: 'position:absolute;top:' + top + 'px;left:' + left + 'px;color:white;font-size:7em;',
					}).appendTo( $("body") );

					var cloudNode = new gameNode();
					cloudNode.cloudDiv = cloudDiv.get(0);

					// Randomize position at start of game
					var top = Math.floor((Math.random() * (groundLevel - 500.0))) + 200.0;
					var left = Math.floor(Math.random() * (rightLimit - 64.0));
					cloudNode.cloudDiv.style.top = cloudNode.top = top;
					cloudNode.cloudDiv.style.left = cloudNode.left = left;

					// Give random velocity
					setRandCloudVelocity( cloudNode );

					// Reset jitter
					cloudNode.jitterCounter = 0;

					// Scale
					setRandCloudScale( cloudNode );

					clouds.push( cloudNode );

				}

			};

			function setRandCloudVelocity( cloud )
			{
				cloud.velocity = (Math.random() * 2.0) - 1.0;
			};


			function setRandCloudScale( cloud )
			{
				cloud.scale = Math.random() + 0.5;
				cloud.cloudDiv.style.transform = "scale(" + cloud.scale + "," + cloud.scale + ")";
			};


			function resetCloud( cloud )
			{

				// Give random velocity
				setRandCloudVelocity( cloud );	    		

	    		// Reset jitter
				cloud.jitterCounter = 0;

				// Scale
				setRandCloudScale( cloud );

				// Reposition based on velocity
				if( cloud.velocty > 0.0 )
	    			cloud.left = -64.0;
	    		else
	    			cloud.left = rightLimit + 64.0;

				cloud.cloudDiv.style.left = cloud.left;
				cloud.cloudDiv.style.top = cloud.top;

			};


			function update()
			{

				setTimeout( 'update()', 16 );

				if( gameStarted == false )
					return;
				

				// Input
				// Space
				if(keyStates["32"] == true)
					playerJump();

				// A 65
				if( keyStates["65"] == true )
					playerMoveHorizontal(-1.0);

				// D 68
				if( keyStates["68"] == true )
					playerMoveHorizontal(1.0);

				// Left 37
				if( keyStates["37"] == true )
					shootWifi(-1.0);

				// Right 38
				if( keyStates["38"] == true )
					shootWifi(0.0);

				// Right 39
				if( keyStates["39"] == true )
					shootWifi(1.0);


				// Update player physics
				// Apply friction
				playerPositionLastFrame = new Point( playerPosition.x, playerPosition.y );

				playerVelocity.x *= friction;
				playerVelocity.y += gravity;

				playerPosition.x += playerVelocity.x;
				playerPosition.y += playerVelocity.y;


				// Is the player still on current bar?
				if( currentBar != null )
				{
					var distanceX = playerPosition.x - currentBar.left - (currentBar.width * 0.5) + 10.0;

					if( Math.abs(distanceX) <= (barThickness * 0.5) )
					{
						// Player is still over current bar. Do nothing
					}
					else
					{
						currentBar = null;
					}

				}


				// Check for new bar if null
				if( currentBar == null )
				{
					checkForBarCollision();
				}
				

				// If the player is over a bar, check if player fell through ground
				if( currentBar != null )
				{
					var barTop = currentBar.top - (currentBar.width * 0.5) - (playerHeight * 0.5);
					playerDistanceFromGround = playerPosition.y - barTop;

					if( playerPosition.y > barTop )// Snap player to top of bar
					{
						playerPosition.y = barTop;
						playerVelocity.y *= -0.5;
					}
				}
				else
				{
					// console.log('player has no bar. falling');
				}


				// Clamp at bottom of screen
				if( playerPosition.y >= groundLevel )
				{
					playerPosition.y = groundLevel;
					playerVelocity.y *= -0.5;
				}

				if( playerPosition.x < 0.0 )
				{
					playerPosition.x = 0.0;
				}
				else if( playerPosition.x > rightLimit - playerWidth )
				{
					playerPosition.x = rightLimit - playerWidth;
				}


				// Update position
				player.css('left', playerPosition.x);
				player.css('top', playerPosition.y);


				// update files
				for(var f = 0; f < numFiles; f++)
				{

					var file = files[f];

					if( file.active == false )
						continue;

					file.velocity.y += gravity;

					file.left += file.velocity.x;
					file.top += file.velocity.y;

					file.fileDiv.style.left = file.left;
					file.fileDiv.style.top = file.top;

					if( file.top > groundLevel )
					{
						file.active = false;
						file.fileDiv.style.visibility = "hidden";
					}

					// File v bar collision
					fileVsBarCollision( file );

					if( file.currentBar != null )
					{
						var barTop = file.currentBar.top - (file.currentBar.width * 0.5) - (playerHeight * 0.5);
						var fileDistanceFromGround = file.top - barTop;

						if( file.top > barTop )// Snap file to top of bar
						{
							file.top = barTop;
							file.velocity.y *= -0.5;
							file.velocity.x *= friction;
						}
					}

					// File v player collision
					var distance = Math.sqrt(
						Math.pow(((playerPosition.y + 10.0) - (file.top + 10.0)), 2) +
						Math.pow(((playerPosition.x + 10.0) - (file.left + 10.0)), 2)
					);
					var threshold = 50.0;

					if( distance < threshold )
					{
						file.active = false;
						file.fileDiv.style.visibility = "hidden";
					}

				}


				// update clouds
				for(var c = 0; c < numClouds; c++)
				{
				    cloud = clouds[c];
				    cloud.left += cloud.velocity;

				    var randOffsetX = 0.0;
				    var randOffsetY = 0.0;
				    if( cloud.jitterCounter > 0 )
				    {
				    	cloud.jitterCounter--;
				    	randOffsetX = (Math.random() * 10.0) - 5.0;
				    	randOffsetY = (Math.random() * 10.0) - 5.0;

				    	// Clouds shrink as they jitter
				    	cloud.scale -= 0.01;
				    	cloud.cloudDiv.style.transform = "scale(" + cloud.scale + "," + cloud.scale + ")";

				    	// Reset cloud when small enough
				    	if( cloud.scale <= 0.1 )
				    	{
				    		resetCloud( cloud );

				    		var randItem = Math.random()

				    		continue;
				    	}

				    }
				    
				    // Wrap clouds
				    if( cloud.left < -64.0 )
				    	cloud.left = rightLimit + 64.0;
				    if( cloud.left > rightLimit + 64.0 )
				    	cloud.left = -64.0;

				    cloud.cloudDiv.style.left = cloud.left + randOffsetX;
				    cloud.cloudDiv.style.top = cloud.top + randOffsetY;
				}


				// Update wifis
				wifiReloadCounter--;
				for( var w = 0; w < numWifis; w++ )
				{
					if( wifis[w].active == true )
					{
						var wifi = wifis[w];
						wifi.left += wifi.velocity.x;
						wifi.top += wifi.velocity.y;
						wifi.wifiDiv.style.left = wifi.left;
						wifi.wifiDiv.style.top = wifi.top;

						// Deactivate if outside screen
						if(
							wifi.left > rightLimit - 64.0 ||
							wifi.left < -64.0 ||
							wifi.top < 0.0 
						)
						{
							wifi.active = false;
							wifi.wifiDiv.style.visibility = 'hidden';
						}

						// Cloud collision
						for( var c = 0; c < numClouds; c++ )
						{
							var cloud = clouds[c];
							var halfCloudSize = 50.0;
							var halfWifiSize = 10.0;
							var distance = Math.sqrt(
								Math.pow(((wifi.top + halfWifiSize) - (cloud.top + halfCloudSize)), 2) +
								Math.pow(((wifi.left + halfWifiSize) - (cloud.left + halfCloudSize)), 2)
							);
							var threshold = 50.0;

							if( distance < threshold )
							{
								wifi.active = false;
								wifi.wifiDiv.style.visibility = 'hidden';
								cloud.jitterCounter = 10;

								// Make random items
								if( Math.random() < 0.5 )
								{
							    	var file = getFreeFile();
							    	file.active = true;
							    	file.fileDiv.style.visibility = 'visible';

							    	file.velocity = new Point(
							    		(Math.random() * 4.0) - 2.0,
							    		(Math.random() * -8.0)
							    	);

							    	file.fileDiv.style.top = file.top = cloud.top - 10.0;
							    	file.fileDiv.style.left = file.left = cloud.left + 10.0;
						    	}

								break;
							}

						}

					}
				}

			};



			function fileVsBarCollision( file )
			{

				// Player could be over a gap, or a new bar. Check.
				for(var p = 0; p < numBars; p++)
				{

					// Is player in the same x space?
					var progressBar = progressBars[p];
					var distanceX = file.left - progressBar.left - (progressBar.width * 0.5) + 10.0;

					if( Math.abs(distanceX) <= (barThickness * 0.5) )
					{

						// The player is over this bar, but are they high enough to climb on top?
						var barTop = progressBar.top - (progressBar.width * 0.5) - (playerHeight * 0.5);

						// Can player reach the top?
						var fileDistanceFromGround = file.top - barTop;

						// Prevent player from landing on/climbing up to new ground if distance is too high
						var climbingThreshold = barTop + (playerHeight * 0.5);
						if( file.top > climbingThreshold )
						{
							// console.log( playerPositionLastFrame.x, playerPosition.x );
							file.left = file.left - file.velocity.x;
							file.velocity.x = 0.0;

							return false;

						}
						else// Player is safely over new bar
						{
							file.currentBar = progressBar;
							return false;
						}
						
					}

				}
				
			};


			function checkForBarCollision()
			{

				// Player could be over a gap, or a new bar. Check.
				for(var p = 0; p < numBars; p++)
				{

					// Is player in the same x space?
					var progressBar = progressBars[p];
					var distanceX = playerPosition.x - progressBar.left - (progressBar.width * 0.5) + 10.0;

					if( Math.abs(distanceX) <= (barThickness * 0.5) )
					{

						// The player is over this bar, but are they high enough to climb on top?
						var barTop = progressBar.top - (progressBar.width * 0.5) - (playerHeight * 0.5);

						// Can player reach the top?
						playerDistanceFromGround = playerPosition.y - barTop;

						// Prevent player from landing on/climbing up to new ground if distance is too high
						var climbingThreshold = barTop + (playerHeight * 0.5);
						if( playerPosition.y > climbingThreshold )
						{
							// console.log( playerPositionLastFrame.x, playerPosition.x );
							playerPosition.x = playerPositionLastFrame.x;
							playerVelocity.x = 0.0;

							//Search for last bar then return
							checkForBarCollision();
							return false;

						}
						else// Player is safely over new bar
						{
							currentBar = progressBar;
							return false;
						}
						
					}

				}
				
			};

			function shootWifi( direction )
			{

				if( wifiReloadCounter > 0 )
					return;

				var wifi = getFreeWifi();

				if( wifi == null )
					return;

				wifiReloadCounter = wifiReloadSpeed;
				
				wifi.active = true;
				wifi.wifiDiv.style.visibility = 'visible';
				wifi.velocity = new Point( direction * wifiSpeed, -wifiSpeed );
				wifi.left = playerPosition.x - 5.0;
				wifi.top = playerPosition.y;

				// Rotate
				if( direction == 1.0 )
					wifi.wifiDiv.style.transform = 'rotate(' + 45 + 'deg)';
				else if( direction == -1.0 )
					wifi.wifiDiv.style.transform = 'rotate(' + 315 + 'deg)';
				else if( direction == 0.0 )
					wifi.wifiDiv.style.transform = 'rotate(' + 0+ 'deg)';
			};


			function Point(_x, _y)
			{
				this.x = _x;
				this.y = _y;
			};



			function Point3( _x, _y, _z)
			{
				this.x = _x;
				this.y = _y;
				this.z = _z;
			};


			function playerJump()
			{
				// Only jump from the ground
				if( playerDistanceFromGround == null )
					return;

				// Don't allow jump if already moving upward
				if( playerVelocity.y < -5.0 )
					return;

				if( Math.abs(playerDistanceFromGround) <= 5.0 )
					playerVelocity.y = -10.0;
			};


			function playerMoveHorizontal( direction )
			{
				playerVelocity.x += direction * 0.5;
			};



			var keyStates = {};
			function keyDown(e)
			{

				// console.log(e.keyCode);

				//prevent defaults
				if( e.keyCode == '37' || e.keyCode == '39' || e.keyCode == '38' || e.keyCode == '40' )
					e.preventDefault();
				
				keyStates[e.keyCode] = true;
			};

			function keyUp(e)
			{
				// console.log(e.keyCode);
				keyStates[e.keyCode] = false;
			}

		</script>

	</head>

	<body onkeydown='keyDown(event)' onkeyup='keyUp(event)'>

		<p class='title'>AwesomeCloud StrapQuest</p>
		<p class='subtitle1'>Made with Twitter Bootstrap and Font Awesome</p>
		<p class='subtitle2'>Press "A", "D", and "SPACE" to move and jump.</p>
		<p class='subtitle2'>Press the arrow keys to shoot wifis at the clouds.</p>

		<i id='player' class='fa fa-female fa-2x'></i>

	</body>

</html>

